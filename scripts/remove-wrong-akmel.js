/**
 * حذف أسئلة "أكمل الآية" الخاطئة (التي في الصور فقط) من data/questions.json
 * ثم إعادة ترقيم id
 */
const fs = require('fs');
const path = require('path');

const repoRoot = path.join(__dirname, '..');
const mainPath = path.join(repoRoot, 'data', 'questions.json');

function normalize(s) {
  return String(s || '')
    .replace(/\s+/g, ' ')
    .replace(/["'']/g, '"')
    .trim();
}

// نصوص الأسئلة الخاطئة (التي في الصور) — نطابق بعد التطبيع
const WRONG_QUESTION_TEXTS = [
  'أكمل الآية: "إن الذين كفروا بآياتنا سوف..."',
  'أكمل الآية: "إنما المؤمنون الذين إذا ذكر الله وجلت قلوبهم وإذا تليت عليهم آياته زادتهم إيمانا..."',
  'أكمل الآية: "إنما يخشى الله من عباده العلماء، إن الله عزيز غفور"؟',
  'أكمل الآية: "إنما المؤمنون الذين إذا ذكر الله..."',
  'أكمل الآية: "إنما المؤمنون الذين إذا ذكر الله وجلت قلوبهم"...',
  '"إنما المؤمنون الذين إذا ذكر الله وجلت قلوبهم" أكمل الآية.',
  'أكمل الآية: "إنما المؤمنون الذين إذا ذكر الله وجلت قلوبهم" ...',
  'أكمل الآية: "إنما المؤمنون الذين إذا ذكر الله وجلت قلوبهم...."',
  'أكمل الآية: "إنما المؤمنون الذين إذا ذكر الله وجلت قلوبهم".',
  'أكمل الآية: "ألا بذكر الله تطمئن القلوب" ما هو الجزء المفقود؟',
  "أكمل الآية: 'وَإِنَّكَ لَعَلى خُلُقٍ عَظِيمٍ' ...",
  'أكمل الآية: "وَإِذَا قَالَ رَبُّكَ لِلْمَلَائِكَةِ إِنِّي خَالِقٌ..."',
  // دفعة ثانية (من الصور المحددة فقط)
  'أكمل الآية: "إن الله لا يغير ما بقوم حتى يغيروا ما بأنفسهم".',
  'أكمل الآية: "إن الله لا يغير ما بقوم حتى يغيروا ما بأنفسهم"...',
  'أكمل الآية: "إن الله لا يغير ما بقوم حتى يغيروا ما بأنفسهم"...',
  'أكمل الآية: "وَنَادَى زَكَرِيَّا رَبَّهُ قَالَ رَبِّ هَبْ لِي مِن لَّدُنكَ..."',
  'أكمل الآية: "وَلَكُم فِي الْقَصَاصِ حَيَاةٌ يَا أُولِي الألْبَابِ"..؟',
  'أكمل الآية: "لا يكلف الله نفساً إلا وسعها، لها ما كسبت وعليها ما..."',
  'أكمل الآية: "إن الله لا يحب..."',
  'أكمل الآية: "إن الله لا يغير ما بقوم حتى يغيروا ما بأنفسهم..."',
  "أكمل الآية: 'إن الله لا يغير ما بقوم حتى يغيروا ما بأنفسهم' ماذا بعد؟",
  'أكمل الآية: "إنما وليكم الله ورسوله والذين آمنوا الذين يقيمون الصلاة ويقنون..."؟',
  "أكمل الآية: 'إِنَّمَا يُؤْمِنُ بِآيَاتِنَا الَّذِينَ إِذَا ذُكِّرُوا بِهَا...'",
  'أكمل الآية: "إنما وليكم الله ورسوله والذين آمنوا الذين يقيمون الصلاة ويؤتون الزكاة وهم راكعون" ما السورة؟',
];

const wrongSet = new Set(WRONG_QUESTION_TEXTS.map(normalize));

// بصمات إضافية للأسئلة الخاطئة (إن لم يطابق النص تماماً بسبب الترميز)
const WRONG_SUBSTRINGS = [
  'إِنِّي خَالِقٌ',   // آية خلق آدم
  'خَالِقٌ...',       // نفس الآية بصيغة أخرى
  'لَعَلى خُلُقٍ عَظِيمٍ', // آية الخلق العظيم + حميد
];

function isWrongQuestion(q) {
  const text = normalize(q.question_ar || '');
  if (wrongSet.has(text)) return true;
  if ((q.category || '').trim() !== 'أكمل الآية') return false;
  return WRONG_SUBSTRINGS.some((sub) => text.includes(sub));
}

const raw = fs.readFileSync(mainPath, 'utf8');
const arr = JSON.parse(raw);
if (!Array.isArray(arr)) throw new Error('questions.json must be an array');

const before = arr.length;
const filtered = arr.filter((q) => !isWrongQuestion(q));
const removed = before - filtered.length;

// إعادة ترقيم id
filtered.forEach((q, idx) => {
  q.id = idx + 1;
});

fs.writeFileSync(mainPath, JSON.stringify(filtered, null, 2) + '\n', 'utf8');
console.log('تم حذف', removed, 'سؤالاً خاطئاً (أكمل الآية من الصور).');
console.log('باقي', filtered.length, 'سؤالاً في data/questions.json');
